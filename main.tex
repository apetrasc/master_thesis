\documentclass[uplatex]{suribt}
%\documentclass[oneside]{suribt}% 本文が * ページ以下のときに (掲示に注意)
\usepackage[utf8]{inputenc}
\usepackage[japanese]{babel}
\title{　深層学習を用いた固気液三相流の超音波計測}
%\titlewidth{}% タイトル幅 (指定するときは単位つきで)
%\centering
\author{松原貞徳}
\studentid{37246227}
%\eauthor{Sadanori Matsubara}% Copyright 表示で使われる

\supervisor{高木周教授}% 1 つ引数をとる (役職まで含めて書く)
%\supervisor{指導教員名 役職 \and 指導教員名 役職}% 複数教員の場合，\and でつなげる
\handin{2026}{1}% 提出月. 2 つ (年, 月) 引数をとる
\usepackage{float}
\usepackage{amsmath} 
\usepackage[dvipdfmx]{graphicx}
\usepackage{amsfonts}
\usepackage{amssymb}
\usepackage{comment}
\usepackage{geometry}
\usepackage{bm}
% \usepackage{algorithmicx}
\usepackage{algpseudocode}
% \usepackage{bbm}
\usepackage{subcaption}
\usepackage{url}
\newtheorem{lemma}{補題}[section]
\makeatletter
  % subsectionの下マージンを小さく
  \renewcommand{\subsection}{%
    \@startsection{subsection}{1}{\z@}%
    {0.4\Cvs}{0.1\Cvs}%
    {\normalfont\normalsize\headfont\raggedright}}
\makeatother
\begin{document}
%\Studentid{37246227}
\setcounter{tocdepth}{2}%\subsectionが目次に含まれるようにしている
% \begin{center}
% \Large{超音波計測による深層学習を用いた菅内流体の気相体積率推定}\\
% \normalsize{松原貞徳 指導教員 高木周教授}\\
% \normalsize{void fraction prediction from ultrasonic measurement technique using deep learning}
% \end{center}
\maketitle
\tableofcontents
\chapter{序論}
\section{研究背景}
数々の調査により、海底には豊富な海底資源が存在することが知られている。\cite{桑木裕基2017南鳥島周辺海域における海底資源評価のための海底地形及び反射散乱強度解析}日本近海の海底資源を掘削、開発する研究は長年続けられてきたが、経済的な理由で実用に足る運搬手法は開発されていなかった。しかし近年では、メンテナンスが容易かつ運搬の仕組みが簡素であるとの理由でエアリフトポンプという機構が注目を集めている。この手法は海底に管をたてかけて、管内下部に資源と海水の混合流を流し込み、それらに圧縮空気を注入し空気が混合流と共に上昇しようとする力を利用して運搬を行うというものである。
当該手法の技術的課題としては、注入する空気の量を制御する必要があるというものが挙げられる。注入する空気量が多く、従来の流動様式マップにおいて環状流だと考えられる領域においても大きく揚鉱性能が下がる分けではないことが示唆されているものの、振動抑制などの観点から効率的な運搬のためにはこれらの注入量を適切に制御する必要がある。\cite{清水2022}また、システムを提案する上では系の構成方程式による性能の見積が重要であるが、従来の気液二層モデリングの式が本当に適切なのかを検証する必要がある。\cite{片岡勲2001気液二相流のモデリングと基礎式}しかし、エアリフトの系においても適用可能な技術は現在開発されていない。運搬する流体は不透明流体であるとの理由から、従来支配的であった光やγ線を利用する方法は使用できず、また、鉱石を運搬する都合上、管にプローブを挿入するような侵襲的な計測手法は好まれない。\par
そこで注目されているのが超音波計測である。超音波はその反射波を測定し情報を利用することで不透明流体に対しても測定が行えると期待されており、また、流れに対して与える影響も無視できるほどに微弱である。海洋技術研究所で行われた実験データの提供を受け、計測された信号波形データと相体積率の間の関係性を解明し新たな計測技術の開発を行うことが期待されており、本研究室ではその協力を受けて技術開発を行った。
\section{関連研究}
エアリフトポンプを用い海底資源を揚降するプロジェクトが進行中であり、本研究室では超音波計測による物理量の測定技術の開発が期待されている。より詳しく言えば、実海域において最適な管径や空気吹き込み条件を取得できればシステム設計にとって非常に望ましく、そのための構成方程式の精度検証により実測値を必要としている。ゆえに、とくに超音波により相体積率を推定する技術開発が重要となっている。超音波を用いた流体計測技術は決して盛んであるとは言い難いがいくつかもの研究が行われてきた。\par
それらに対するアプローチを大別するものとして、純粋な物理的考察を重ねていくことによって予測を行うもの、データ駆動の手法によって予測を行うものが存在する。研究の概要を端的に示すために、まずエアリフトポンプの揚降実験に関する研究をまとめ、その後に混相流計測における研究を紹介することにする。

\subsection{エアリフトポンプを用いた揚降実験に関する研究}
2022年には、産業技術総合研究所の設備を利用して、本研究室の高木教授らによって200m縦型水槽を用いた水ー空気系及び泥水・空気系によるエアリフト実験が行われた。そこで、1990年代のマンガン団塊採鉱プロジェクトにおいて取得されたデータを良好に再現することを確認し、また、注入する空気量によらずロバストな揚水が行えることを示した。今後の展望として、管の中の流動状態を超音波により把握することを目的としていることが述べられている。。
\subsection{混相流計測手法に関する研究}
流体計測技術を開発する研究は多岐にわたる。一般的なものとして、以下のようなものが挙げられる。
・写真計測\par
・締め切り法\par
・PIV,PTV\par
・電気プローブ、光ファイバプローブ、ワイヤメッシュなど\par
・X線・γ線\par
・静電容量方式\par
本稿においては、機械学習あるいは超音波及びそれに準ずる手法に焦点をあてて解説を行うこととする。例えば、写真計測、PIV・PTV、ワイヤメッシュを用いた手法は流体工学上重要であるが、エアリフトへの系への応用可能性に乏しいので一部にとどめることとする。\par
電磁波を用いて気液二層流における流動様式を分類する研究は、直近のものでは\cite{DLFlowPattern}がみられる。ここでは、空気と水の透明な流体にワイヤメッシュを通して計測波形を取得しこれらを深層学習で処理することによって結果を得るといった手法を採用している。これらは、研究機関でデータセットの共有が行われており、それらを利用して流動様式の分類を行う機械学習モデルを訓練・評価している。例えばＨＺＤＲというデータセットはヘルムホルツーゼントラム　ドレスデンールーゼンドルフ研究機関で、ＴＵＤはドレスデン工科大学で取得されたものを示し、これらを用いて識別における汎化性能が示されている。\par
他にも、\cite{bishop1993analysis}では、γ線を利用した計測データをニューラルネットによって処理し、相の幾何学的配置と相体積率を高い精度で予測した研究がある。このデータは、北海の原油の転送パイプラインにおいて、油、水、ガスの含有率を非侵襲的に測定する技術を開発するために人工的に生成されたデータであり、実機のものではないことに注意が必要であるが、混相流の測定データを機械学習で処理する点が革新的であった。これらの研究を皮切りに、従来の物理学的アプローチに加え機械学習による推定が様々な研究者によって始められた。例えば、\cite{imitatebishop2021}では、γ線計測データを機械学習で処理することによって、相対誤差5\% 以内で相体積率の予測に成功した。しかし、これもシミュレーションにすぎず実機による検証が必要である。
以降、超音波を用いた研究に焦点をあてて紹介する。超音波を用いた手法と電磁波を用いた手法は強度の取り扱いといった点において類似点が多いが、決定的な違いとしては、超音波は空気を通り抜けることが出来ず全反射するということである。しかし、それらを克服して予測を試みた研究が数多く存在する。\cite{figueiredo2016use}では、超音波計測において4つのトランスデューサからの信号を用いてニューラルネットを訓練することにより気相体積率を高い精度で予測することに成功した。また、同一人物であるが2020年において\cite{FIGUEIREDO2020110189}では、超音波計測において1つのトランスデューサからの信号を用いて気液二層流の気泡流、スラグ流、チャーン流の3種の流動パターンを97.9％の精度で識別することに成功した。なお、この研究と類似するものが2024年に本研究室の尾花によって行われており、これらのコードを一部改良することによってスラグ、チャーンの2様式の分類ではあるが90％の精度で識別に成功している。流動様式の分類が高精度で行えることが示されたため、流動様式ごとの経験式・実験式のようなものがあればそれらを統合して予測することが可能だと考えられるが、超音波画像に基づく量での実験式は存在せず解決には至らなかった。なお、これらにおいては管径への汎化性能を得る手法についての議論は成されていない。\par
なお、統計的解法に頼らず純粋に物理的な手法も存在する。例えば、\cite{park2022gas}では、気泡の形状に関する適切な仮定を行うことによりモデル化を行い、注入した気泡の体積率を相対誤差30％の精度で推定することに成功した。このアプローチとしては、反射強度及びドップラー効果を利用して気泡の位置と速度の推定を行い、統計的な仮定を行うことによって予測するといったものであった。しかし、これらは極めて微量な体積における推定結果であり、実運用の際の40～80％の体積率を推定することには適用できない。\par
エアリフト揚降システムを開発する上で、入念な技術調査が行われてきた。流体力学においてはその計測手法が長らく研究されてきており、理論的工学的研究が数多く存在する。その中で、下にあるようないくつかの技術が検討された背景がある。\par
・写真計測\par
・締め切り法\par
・PIV,PTV\par
・電気プローブ、光ファイバプローブ、ワイヤメッシュなど\par
・X線・γ線\par
・静電容量方式\par
これらのうち、実験により写真計測、PIVなどの手法がまず検討されてきた。しかし、撮影された画像から有益な情報を得ることは困難であった。\par
次に、電気プローブ、光ファイバープローブ、ワイヤメッシュなどの方法が検討されてきた。しかし、これらは粗大固体粒子を含む系には適用不可という側面がある。\par
X線・γ線を利用する方法に関しては、固気液三相（三成分）だと体積率を取得する技術が存在しないことに加え、放射線を取り扱うので大口径化などの点で見通しが不透明であるという問題点があり、静電容量方式でも固気液三相だと体積率を得られず、軸対称性が崩れた場合などは計測できないことが予想されるのである。これらの理由により、超音波によって流体を計測する試みが行われてきた。様々な取り組みが各所で進行中であるが、例えば共同研究を行っている北海道大学においては純粋な物理学的アプローチに基づく技術開発が行われてきた。しかし、混相流には膨大な変数が存在しモデル化が極めて困難である。従来支配的であった光学的な計測も使用できず、また、光学的計測と異なり超音波計測においてはノイズの影響が極めて大きいことが実験的に知られており、信号波形から人為的に特徴を抽出するアプローチが限界に達しつつある。\par
混相流計測には、X線やγ線を利用したものや、静電プローブを利用したものなど様々なものが存在する。古いものだと


\subsection{その他の研究}
シミュレーションを活用するアイデア自体は、本研究室においてかねてより提案されてきた。いかに数値計算の検討を行う材料となる研究を紹介する。\par
例えば2023年には、管の断面を模した系での数値計算および、得られた信号波形をもとに気泡のサイズと位置を機械学習によって推定する研究がWangによって行われた。この中で、気泡がたった5つかつシミュレーションという条件下でも予測が困難であると示唆された。しかし、この研究にはデータセットの統計に関する議論が行われておらず、よりバランスされたデータを用いることによって再現できる可能性がある。また、その中で実機実験の必要性と3次元シミュレーション、固気液三相流のシミュレーションを行うことを提案している。\par
2024年には尾花によって上昇気液二層流の超音波計測の技術がまとめられ、超音波のTime-stripイメージをもとに学習させるアプローチにおいてスラグ流・チャーン流の識別が行われた。また、この中で数値計算による計測データを学習させることが提案されている。\par
2025年には渡辺によってCNNを用いた相体積率及び見かけ流速の推定が行われ、有効な前処理手法についての調査が行われた。その中で二相流においては高精度での推定が可能だが、固気液三相流では困難であると主張した。しかし、全体的にデータが極めて少なく、それゆえ十分なテストデータを用意できず、有効かどうかの検証が十分ではない。また、学習されたパターンの物理現象を、計算機理論と照らし合わせて議論する必要がある。\par
他にも、純粋な流体力学的な固気液三相のシミュレーションとしては、例えば\cite{小野寺直幸2014gpu}や、

\section{研究目的}
以上に述べたとおり、従来の流体計測技術では当面の技術的課題を解決できず、我が国においては主に北海道大学と我々のチームで超音波での技術的開発が目指されてきた背景があり、本研究室においても関連研究が行われている。前述のとおり系が極めて複雑であり、物理的な現象論的アプローチも限界に達しつつある。そこで、本研究においては複雑系の取り扱いに強みを持ち、それらの特徴、表現をデータから取得できる可能性のある深層学習の技術を用い新技術を開発することを目的とした。とくに、相体積率を推定する目的のもと実験データおよび数値計算を活用してデータを入手し、現象論に基づいた考察を行うことを目的とする。

\subsection{本論文の構成}
まず初めに研究の発端となった状況及びその動機に触れることによって動機を示し、そのうえで各所で様々な研究が行われてきたことを述べた。その中で顕著なものに焦点を当て、流体工学分野での混相流分野の概要や、流体計測技術を調査した。それを受けて、本稿において数値計算を活用して得られた知見やデータを信号処理によって適切に機械学習・深層学習と組み合わせ、新たな計測技術を提案する。その際、使用した技術を技術的背景としてまとめ、本稿の核をなす数値計算、そのデータの処理を体系づける信号処理、そして得られたデータをもとに予測を行う深層学習について概論を示し、それらに基づいて本稿における数値計算の結果とそれに基づく知見、さらにそのデータを学習させた場合の性能と評価、今後の展望を示す。
\chapter{技術的背景}
\section{超音波計測}
超音波とは振動である。それゆえ、媒体を必要とする。その媒体の物性によって減衰や反射の特性が変化するが、伝播した超音波、すなわち計測物体の振動の情報を圧電効果を利用することによって電気信号の形として取得し、適切に変換することによってはじめて信号波形を計測することが可能となる。それらは電子回路によって適切に処理され、信号波形として対象物を計測した際の情報を利用できる。本研究においては電気回路については簡単に触れるのにとどめることとし、あくまで取得された計測波形に基づいて議論を行う。

超音波を含む音は、周波数、強度、波形で表すことが可能である。すなわち$A$を振幅、$\omega$を各振動数、$\phi_0$を位相とした際に、音は 
\begin{equation}
    f(t)=Asin(\omega t +\phi_0)
\end{equation}
として表現されるので、周波数$f=\omega /2\pi$, 強度$I=\frac{1}{2}Z_0 A^2 \omega^2$, 波形$s$
として表現できる。  

超音波の性質として、周波数が高いほどまっすぐ進みやすい一方で、強度が減衰しやすいというものがある。超音波は物質の界面で反射する性質がある。これらの反射と入射・および減衰と透過の影響を特徴づける量が音響インピーダンス$Z = \rho c$（密度×音速）である。

$Z_0$が大きく異なる物質の界面では超音波は反射する。ゆえに超音波は液相から固相に入ることはできるが、気相に衝突した際にはほぼ全反射される。

\section{音響信号処理}
これら超音波計測の際の信号を処理する方法論について述べる。これらについては音声信号処理に参考とすべき内容が多く、本研究に対しても有効と思われる手法に絞り紹介する。


\subsection{数理変換}
信号は目的に応じて適切に変換される必要があり、それを行う手続きは長い歴史の中で十分議論されている。フーリエ変換やヒルベルト変換は頻繁に用いられる。フーリエ変換においては定常性の仮定を置く目的でSTFT[\cite{小野順貴2016}]といった派生形があるが、今回は使用していない。ヒルベルト変換に関しては、\cite{2020SciPy-NMeth}を使用した。

\subsection{超音波画像法}\label{ultraimage}
超音波画像は、特に医療分野で広く用いられている。妊婦のお腹の中の胎児を可視化しようとした場合には、人体に影響を及ぼす電磁波などよりも、力学的な刺激であり人体に無害な超音波を用いて可視化することが好まれる。ここで用いられているのが、超音波画像法と呼ばれる方法である。これは、超音波パルスを照射してその透過波、反射波を記録し、その強度に応じて色分けして表示することによって画像を得る手法である。これらは、一般に信号波形の包絡線を取得し、適切に対数圧縮を施すことによって実現される。\par
その手続きを以下に示す。
\begin{description}
    \item[Input:] Signal waveform data $s(t)$, trigger detection function $\mathrm{TriggerDetect}(\cdot)$, segment length $L$, number of vertical repetitions $N$
    \item[Output:] Ultrasonic image data $I\in \mathcal{R}^{H\times W\times C}$
\end{description}
\begin{enumerate}
    \item $T \gets \mathrm{TriggerDetect}(s(t))$ (Extract the list of trigger time points)
    \item \textbf{for} $i = 1$ to $N$ do
    \begin{enumerate}
        \item $t_i \gets T[i]$ (Time point of the $i$-th trigger)
        \item $v_i \gets s(t_i : t_i + L)$ (Obtain the signal segment of length $L$ from the trigger time point)
        \item $I[i, :] \gets v_i$ (Store as the $i$-th row of the ultrasonic image)
    \end{enumerate}
    \item \textbf{end for}
    \item Output $I$ (the generated ultrasonic image data)
\end{enumerate}

\subsection{ノイズ除去}
本研究における学習データに関してだが、想定される電圧を超えているため、欠損値が多く存在していることが確認されている。これらに関しては、暫定的にすべて0で埋め合わせるという操作を行った。\par
また、命名規則が誤っているものが存在した。対応表の中に記載されているのにもかかわらずデータが存在しなかったり、あるいはその逆の場合が見られた。また、データそのものが破損しておりロードできないものも存在した。これらに関しては、筆者が一つ一つ確認して除外あるいは修正し、ファイル名と誤りなく対応するように変更した。具体的には、元データ408のうち、目標値が存在するが信号がないものが35、信号が存在するが目標値が存在しないものが47存在した。これらは、時刻で命名されているため数分のずれがある場合がおおく、これらを手作業で修正した。\par
また、データが産総研由来のものに関してだが、トランスデューサを管に近づけすぎたために多重反射と干渉しあってしまい、特別な処理が必要である。今回は対応には至らなかった。

\section{数値計算手法}
本研究においては、実機計測データに加え、シミュレーションによって生成した計測データも利用した。ただし、固液二層において機械学習モデルを用いて実機データを評価する際には、実機データが混入しないよう細心の注意を払った。また、実機を模した機械学習用データを作成することを目的とした。

\subsection{計算原理}
超音波の伝播については波動方程式によってモデル化されており、系の時間発展を記述することが可能である。この方程式は原理的には二階の非線形偏微分方程式であるが、流体の保存則を活用することによって複数の一階偏微分方程式に分解することができ、数値的にも安定した計算が可能になる。

例えば、減衰なしの流体のもっとも単純な系の運動を記述する方程式として運動量保存則、質量保存則、圧力ー密度の関係式が存在する。これらはそれぞれ
\begin{align}
    \frac{\partial \mathbf{u}}{\partial t }&= -\frac{1}{\rho_0} \nabla p \\
    \frac{\partial \rho}{\partial t} &= - \rho_0 \nabla \cdot \mathbf{u} \\
    p&= c_0 ^2 \rho
\end{align}
が挙げられるが、これらを整理すると
\begin{equation}
    \nabla^2p - \frac{1}{c_0^2} \frac{\partial ^2 p}{\partial t^2} =0 
\end{equation}
の、波動方程式を得る。

すなわち、これらの波動方程式の解は、流体の保存則の解と等価である。
実際は減衰などのより現実に即した効果を付した項が追加され、より複雑な方程式となる。これらの式を離散化することによって、連続な量を対象とする本来の偏微分方程式を計算機で数値的に解くことが可能となる。

\subsection{疑似スペクトル法（pseudospectral method）}
シミュレーションにおいてはいくつかの数値的なモデルが存在する。そして、それらへの最適なアプローチは系に依存する。それらに対して、heterogeneous(不均質)な系、つまり様々な材質から成る系についての解を求めたいとする。こういった問題を解くには、有限差分法（finite difference）あるいは有限要素法(finite element)が考えられるが、有用な精度を達成するには音波長あたり10点が必要である。これらの方法では、過度に計算コストがかかってしまいがちである。

これらは、有限差分法が、もとの関数の近傍で近似を行うことに起因する。勾配を評価する際、高精度の値を得るにはより高次の多項式をできるだけ多くの点でフィッティングする必要がある。これらに対処するのがフーリエ選点法である。この手法は、データ点すべてにフーリエ級数を割り当てる。基底関数が正弦波的な形状を持つために、有限差分法と異なり高次の多項式を必要とせず、かつ2点でフィッティングできるので必要なグリッド数も少ないのである。よって、波動伝播においてはより効率的な計算手法であるとされる。

\subsection{安定性解析}
系の方程式を記述して、それを数値的に解く場合にはいくつかの検定が存在する。
\begin{description}
    \item[1.]離散化に伴う連続量との乖離
    \item[2.]安定性解析
    \item[3.]計算結果の正しさ
\end{description}

離散化に伴う量は、$\Delta t $を十分小さくとることによって導関数に一致することはここでは自明とする。よって、重要なのは数値的な誤差が時間発展によって増大してしまうか否かである。これらは、十分$\Delta t $を小さくとることが望ましい一方で、計算時間の制約からできる限り粗くとることが望ましい。しかし、ここでもいくつかの検定が存在する。ただし、一般に適切な領域で$\Delta t $を小さくとって計算をやり直し、その値が収束することによって正しさを証明する手法である。低周波の波長の伝播の計算はより高周波の伝播によって保障されているので、高周波の計算がそれを担保するのである。

\section{機械学習}
機械学習は、データからパターンを抽出する技術である。より詳しく言えば、入力と出力の関係をモデル化し、モデルによる予測結果と目標値との誤差が小さくなるようにモデルのパラメータを更新する技術である。このような更新を行うためには誤差関数の値を最も小さくする方向に適切にパラメータの更新量を求める必要があり、そのために誤差関数そのもののパラメータに関する勾配を評価する必要がある。パラメータの更新量を求める最適化アルゴリズムには、確率的勾配降下法（Stochastic Gradient Decent,SGD）に基づいた数々の手法が存在する。\par
この技術を駆使し、本研究では、超音波信号波形から相体積率を推定する回帰問題として定式化する。入力$\mathbf{x} \in \mathbb{R}^{1 \times W \times C}$（$W$: 信号長、$C$: チャネル数）から連続値$y \in \mathbb{R}$（相体積率）を予測する関数$f: \mathbb{R}^{1 \times W \times C} \to \mathbb{R}$を学習する。

本研究では深層学習（CNN、Transformer）を中心としたニューラルネットワークアプローチを採用する。これらの手法は、信号波形から物理量を推定する関数を直接学習できる利点がある。


\subsection{正規化・正則化}
今回設計したモデルには、学習を円滑に行うためにいくつかの統計処理を施してある。今回、シミュレーションで得られるデータは数khPaにも及ぶ圧力変動であるのに対し実機試験で得られるデータはトランスデューサの―2～＋2Vの範囲の電圧変化である。シミュレーションのデータを学習に利用し、実機データでの性能をテストするというアプローチをとるとは言え、そのままでは入力データにおける数値的な変動があまりに大きい。ゆえに、データのスケールをそろえるという操作が重要となる。このような操作は正規化と呼ばれ、単にシミュレーションと実機に見られる値の差異のみならず、同じ入力間のデータや、隠れ相を通った後のデータに対しても同様に重要である。

\subsection{モデルの種類と概要}
深層学習の技術はデータが大量に存在し、モデルが不明であり、かつ「存在するとわかっている」ような分野において発展してきたという背景がある。Transformerとは自然言語処理の分野で考案されたアルゴリズムであり、自然言語のみならず画像処理、系列処理といった様々な分野に応用され、従来のアプローチの性能を大きく上回るという研究成果が様々な分野において発表されている。
本研究では、特徴、表現をデータから取得できる可能性のある深層学習の技術を用い技術的課題の解決を目的とした。とくに、相体積率を推定する目的のもと実験データおよび数値計算を活用してデータを入手し、現象論に基づいた考察を行うこととする。\par
また、CNNの性質として、画像中のパターンの、位置、回転、大きさに対して頑健性を持つという性質がある。あるいは設計思想として、画像中のパターンの普遍性が定性的にわかっており、これらを効率的に学習できるような構造としてCNNが考案された背景がある。例えば、我々は画像中のネコのパターンを、ネコが拡大されようが回転されようが、位置をずらされようが検出することができる。これらを用いることは、管径によらず、またトランスデューサの微妙な位置のずれによらず物理量を予測可能なパターンの学習につながるのではと期待される。\par
なお、これらはCNNの畳み込み構造、積み重ねによる局所的受容野を広くとることによって達成される。局所的受容野が狭すぎれば、そもそものパターンを認識できず、ゆえに位置的な頑健性を得られない。よって、多くの文献で採用されているような、3×3のカーネルで設計された数々のモデルをそのまま使うことはできない。
\subsection{モデル解釈}
CNNやほかのアーキテクチャで学習された特徴の解釈に用いられる方法はいくつかある。例えば、学習したカーネルそのものをプロットする方法である。これらに関しては、深層学習の際に用いたカーネルをすべてプロットするというものである。一般に、\cite{Bishop:DeepLearning24}にあるように、下層のカーネルほどエッジのような機械的な特徴を、上層に行くほど高次の概念を学習していると解釈される。\par
一方、入力のどの領域が予測に最も寄与しているかを可視化する方法として顕著性map(saliency map)というものがあげられる。これらは、入力のどの領域に大きな重みを割り当てているかを確認する方法である。その最たるものがGrad-cam\cite{Selvaraju_2019}と呼ばれる方法である。これらの機能の詳細に立ち入る前に、その応用例に焦点を当てる。以下は、原論文にあったような、自然画像を入力として分類を行うモデルである。
\begin{figure}[htbp]
    \centering
    \includegraphics[width=0.5\linewidth]{pictures/explanation/grad_cam_explained.png}
    \caption{画像入力に対するsaliency mapを可視化したもの。1枚の画像に犬と猫が映っているが、犬、猫それぞれのクラス予測に対応する入力箇所が可視化されている。}
    \label{fig:gradcam}
\end{figure}
ある画像に犬が含まれるか、猫が含まれるかを識別する場合は、まずそのカテゴリに属する確率を計算し、そのうえで最大の確率を持つクラスに割り当てるという処理がされる。（Decision theory, 決定理論と呼ばれる）注意すべきは、この画像には、犬に属する確率も猫に属する確率も等しく存在する点である。その上で、Gradcamは、畳み込み層最終の出力の変化が、Softmax関数に通す前の値にどれだけの変化を起こすのかというものを可視化する。式で言えば、

\begin{equation}
    \alpha_k=\frac{1}{M_k}\sum_i\sum_j{\frac{\partial a^c}{\partial a_{ij}^k}}
\end{equation}
の値を計算し、これらの重みでもって最終層を強調する。これらの解釈としては、例えばある位置のピクセルの画素強度がわずかに変化したことにより、計算した確率に大きな変化をもたらしたのならば、それは画像中で重要な箇所であると解釈される。それらの値を各ピクセルに対して計算し、その変化の度合いの大きさに応じてヒートマップを作成することにより、その画像に対する重要な箇所を可視化することができる。
強調すべきは、ニューラルネットにおいては全く同型の写像の機能を持つ関数が学習された場合でも、別々の重みが得られるということである。Bishop\cite{PRML}によれば、これらは同様に良いモデルであるとされる。しかし、今回のような事例では、ある重みのセットよりも好まれる重みのセットが存在する。実機試験においては超音波パルスの形状が機器の性質により扁平になってしまうケースがあり、予測に寄与しない部分にまで同様の重みを割り当てるモデルはロバストな予測に寄与しない。
なお、Grad-camのCamはClass Activation Mappingのことであり、今回のような回帰を行う場合には名称として適切でない。しかし、分類と回帰の違いは最終出力をSoftmaxに通すか否かであり、最終出力における貢献を可視化する手法であるので回帰の場合にも同様に適用できる。本研究では、\cite{Bishop:DeepLearning24}に倣い、"saliency map"という名称を用いる。
\subsection{ベイズ最適化}
機械学習は、人間が主観的に決定するパラメータを必要とする場合がある。これらをパラメトリックモデルと呼ぶ。これらは、予測精度が向上するようにいくつものパラメータを人間が試すということが多いが、それらへの正当性が不明であり、わずかな変化に対して脆弱である場合がある。これらのハイパーパラメータ最適化に際し、ベイズ最適化というアプローチがしばしば採用される。ベイズ最適化は、パラメータの事前分布を仮定し、その分布に従ってパラメータをサンプリングすることによって、最適なパラメータを探索するアプローチである。特に、ガウス過程をサロゲートモデルとして、ハイパーパラメータの不確かさを統計的に評価し、その値に応じたパラメータの提案を獲得関数によって規定し探索を行う。
\chapter{実験手法・実験系}
\label{experimental_settings}
\section{実験装置・計測機器}
協力を受けた海洋技術安全研究所の実験設備の模式図を以下に示す。\par
\begin{figure}[htbp]
    \centering
    \includegraphics[width=0.7\linewidth]{pictures/explanation/experimental_setup.png}
    \caption{実験装置の概念図。パイプの中を空気・ガラスビーズが流れている。}
    \label{fig:experiment_setup}
\end{figure}
これら実験系は、上昇鉛直管における固液二層流、気液二層流、固気液三相流を超音波で計測した場合の信号データのほか、空間平均の相体積率や画像データに関しても取得することが目的とされており、いくつかの設備が複合されてある。信号データを取得できるトランスデューサ及び画像データを取得でき超音波照射と同期する設定のもとハイスピードカメラが設置されている。なお、空間平均の相体積率は締め切り法と呼ばれる手法で計測されており、これは上下バルブを同時に遮蔽し、バルブ間に取り残される媒体を測定する手法である。固相に関してはガラスビーズの個数が数えられ、気相、液相に関しては液相のみ体積率の比として測定される。1から液相、固相の割合を引くことによって気相の体積率が求められる。
概念図を以下に示す。この図のポンプにより流体の駆動力を得、適切に空気を注入することによって混相流が再現される。
\begin{table}[htbp]
    \centering
    \begin{tabular}{ccc}
    \hline
         Transducer settings(TX-4-5-8-40, Met-Flow) & value & Unit  \\
         \hline
         Ultrasound frequency &  4 & $\mathrm{MHz}$\\
         Pulse repetition frequency & 3 & $\mathrm{kHz}$\\
         Cycles of ultrasound pulse & 4 & \\
         Sound speed & 1480 & $\mathrm{m/s}$\\
         Sampling rate & 52.08 & $\mathrm{MHz}$ \\
         Active diameter of transducer & 5 & $\mathrm{mm}$\\
         Measurement time & 5 & $\mathrm{s}$\\
    \hline
    \end{tabular}
    \caption{transducer settings in the experiment}
    \label{tab:transducer_settings}
\end{table}
\section{実験条件・手順}
これら実験系は、上昇鉛直管における固液二層流、気液二層流、固気液三相流を超音波で計測した場合の信号データのほか、空間平均の相体積率や画像データに関しても取得できることが目的とされており、いくつかの設備が複合されてある。信号データを取得する目的でトランスデューサが、画像データを取得する目的で超音波照射と同期する設定のもとハイスピードカメラが設置されている。なお、空間平均の相体積率は締め切り法と呼ばれる手法で計測されており、これは上下バルブを同時に遮蔽し、バルブ間に取り残される媒体を測定する手法である。超音波計測、流量計測が終了次第、二つのバルブを急閉し流れを遮断する。内部の水位及び固体粒子の個数を数えることにより、液相、固相の体積分率を得ることができる。ただ、この手法においては急な流れを堰き止めることによるバルブの劣化が著しく、水漏れが発生する場合がある。よって、気相は実際の値よりも大きめに、液相は実際の値よりもやや小さめに測定される場合があることに注意が必要である。一方で、そのような値は極めて微小である。
トランスデューサの設定や系の物性についての条件を以下に示す。これらは\cite{park2022gas}による報告をベースに提供された資料があり、それらによると条件は以下のようであった。
これらの仕組みに関してだが、使用したトランスデューサの原理は、ある固定された位置における音圧変化を電圧に変換し、それを信号波形の形で記録するものである。そして、それらの音圧ー電圧の関係においては線形な範囲が存在するとされ\cite{}、本実験においては機器の指定する印加電圧内で実験していることから線形であると考える。\par
この領域では、シミュレーションで得られる音圧変化と、実機において計測される電圧変化は、適切なスケール化及びダウンサンプリングを施すことによって入力において数値的に同じ統計・次元を持つようにすることが可能である。\par


\section{データ取得方法}
本研究における学習データに関してだが、計測機器の不具合といった何らかのエラーにより不適切な値を取ることがある。そういった値は適切な学習を阻害しうるので適切に除去する必要がある。これらに関してはデータ分布を適切な手法で確率分布としてモデル化し、値を取る確率が極めて小さいものを外れ値として除外するという案が考えられる。

今回、実機データとその際の測定記録を拝見した際には、恐縮ながら命名が誤っていたり、データが破損している事例がしばしば見られた。例えば、実機測定データは存在するがそれらに対応する相体積率の目標値がなかったり、その逆がみられた。これらは筆者が手作業で確認し、修正した。今後このデータに基づいて解析を行う場合には、解析の担当者の負担が増すことがあるので、注意されたい。

また、後述するように、実機データにおいてはシミュレーションと異なり尖ったピークは一般に現れない。実際には尖った先端を切り取って台形にしたような信号波形になることが確認されている。これらに対し、適宜関数をフィッティングしてピークを補完し、より正しい値でのスケーリングを行うことが考えられる。その技術は、例えば\cite{kyodaisenpai}の技術を使えば解決できる可能性はある。
\chapter{計算系}
本研究においては、実機計測データに加え、シミュレーションによって生成した計測データも利用した。すなわち、シミュレーション生成のデータをもとに機械学習モデルを訓練・検証した後に実機データにおいてそれを評価するモデルも存在する。実機を模した機械学習用データを作成することを目的とした。

\section{計算系の設計}
数値計算を実行するためのオブジェクトを点群として定義し、それらに対し適切な物性値や信号遅延などを与えることによって実機に近い測定データを得ることが可能となる。計算系において存在する媒質は、固気液三相流の場合も含め石、塩化ビニル、水、空気、ガラスであり、これらをトランスデューサによって計測するという設定をなす。一般的な設定において、2次元では任意のセンサー配置ができる一方、現実の測定に即したビーム収束などは再現できない。一方、3次元では送信器、受信器でそれぞれ一つのトランスデューサしか実装できないが、各素子への信号の送信に時間遅れを持たせて、超音波に指向性を持たせることが可能となる。計算に使用した各種物理量はconfig.jsonにも記載されているので、そちらを参照されたい。以下は、それぞれの設定理由を示す。
\subsection{グリッドサイズ}
次に、計算を行う上では格子点、その幅を計算機の性能を鑑みながら決定しなければならない。理想的には、計算機の性能が、シミュレーションに必要な性能を大幅に上回っている状態が望ましく、計算機の制約を考えずに設計したい。しかし、研究室の計算環境ではやはりそれも考慮して計算系の設計をする必要があった。以下、計算系の要件を示す。\par
まず実験設備のスケールとしては、トランスデューサが超音波を照射しその反射波を記録する目的から、
\begin{equation}
    l_x\ [\mathrm{mm}] > 82 \ [\mathrm{mm}]
\end{equation}\par
である必要がある。また、幅に関しては管の直径よりも太くある必要があるので、
\begin{equation}
    l_y \ [\mathrm{mm}]> 32 \ [\mathrm{mm}]
\end{equation}
が必要である。
なおこれらは下限であり、実際はもう少しゆとりを持たせることが好まれる。\par
他方、計算を正確に行うための計算理論による要件を示す。先に述べたように、波動の位相を正確に取得するためには、$\lambda_{min}=c_{min}/f$,$c_{min}$を、系の構成要素の中での最も遅い伝播速度として
\begin{equation}
    2 \Delta x\ [\mathrm{m}] < \lambda _{min}\ [\mathrm{m}]
\end{equation}
である必要がある。
例えば固液二層の場合では律速が水なので$c_{min}=1500 \ [\mathrm{m/s}]$, 気液・固気液では空気が律速となるので$c_{min}=340 m/s$となる。
ゆえに、例えば固液を例にとると、現在使用している超音波の波長が$4 \ \mathrm{MHz}$であるので
\begin{equation}
    \Delta x \ [\mathrm{m}]< \frac{1500}{2 \cdot 4 \cdot 10^6} \ [\mathrm{m}]= 0.1875 \ [\mathrm{mm}]
\end{equation}
を満たさなくてはならない。ただし、2倍、3倍などの高周波成分などの量を再現しようとした場合には、その分だけ小さくとる必要がある。これらは、フーリエ変換のスペクトルで$12 \ [\mathrm{MHz}]$のピークがわずかに見られたためそれらを再現する目的で$0.0625 \ [\mathrm{mm}]$よりも小さい値に設定する必要があった。\par
ここで、格子点数の要件について記す。今$l_x =N_x \cdot dx > 82 \ \mathrm{mm}$であるので、
\begin{equation}
    N_x > 1312
\end{equation}
が示される。計算機上は2の累乗だと計算効率が良いので、$N_x=2048$を採用してある。
同様の議論で$N_y > 512$が必要だが、これでは計算系の境界に接してしまうので望ましくない。そこで、それよりも大きくかつ効率が良い値として$N_y=768$を採用した。\par
最後に、$N_z, dz$について触れる。これらは、計算機の上限から$N_z=128$とした。これらによりGPU上で約20GBの仮想メモリが割り当てられ計算が実行された。
\subsection{固液二層流}
系を規定する媒体は、ガラスおよび水の二種類である。また、実験記録にはガラスビーズの直径が2.5 mmと記載されてある。よって、事前にガラスビーズの個数を規定しておき、それを空間的に配置して計算系を作成した。この際、複数のガラスビーズの座標はBox-Mullar法と呼ばれる乱数生成のアルゴリズムをベースに、適当な検定を設けることによって生成した。以下にその詳細を示す。これらによって生成した座標は$\{x | x\in[-1,1]\},\{y | y\in [-1,1]\},\{z |z \in [0,1]\}$　の区間で生成されており、これをグリッドサイズの分だけ拡大することによって計算系の座標として利用してある。
トランスデューサの設定としては以下のものを用いた。


\subsection{気液二層流(未実施)}
今回は空気と水の二種類によって系が決定される。固液二層との違いは、気泡の形が球形を成すとは限らず、またその形状も複雑であり、体積も一定でないということである。著しく非軸対称であり、分裂の最中のもの、合体の最中のものなど混迷を極める。一方で、気液二相に関しては画像解析に基づくいくつかの知見が存在しているのも事実である。例えば坂口ら\cite{sakaguchibubble}の研究によれば、大きい気泡は菅中央に、小さい気泡が間壁付近に分布することが明らかになった。また、古典的な教科書である\cite{batchelor2000introduction}によれば、$6\times 10^{-4}c.c$程度の小さい気泡に関してはほぼ球であると仮定してよく、この値を超えると扁平となり振動しながら上昇する。次に、体積が5ccよりも大きくなると球の一部を切り取ったような形になり、また、その仰角は泡の体積によらず46°～64°となる。最後に、菅いっぱいを占めるような大きな泡に関しては、形状定数$\alpha$、気泡の上昇速度$U$,重力加速度$g$、よどみ点における気泡表面の曲率半径$R$を用いて
\begin{equation}
    \alpha^2 U^2 = gR
\end{equation}
の形状をなす。また、$U$は円管の内径を$D$として$0.48\sqrt{gD/2}$に等しく、$R/D>0.26$ならば半径$R$の帽子型形状の泡よりも小さい。ゆえに、管を埋めるほど大きくない泡は大きい泡へと追いついて合体することを示すという。最後に、これら帽子型から十分下方では、質量保存の式から
\begin{equation}
    \pi \frac{D^2}{4} U=\pi {\frac{D^2}{4} - (\frac{D}{2}-d)^2}\sqrt{2gx}
\end{equation}が得られ、基本の先端からの距離を$x$として
\begin{equation}
    \frac{2d}{D} =1 -\sqrt{1-\frac{U}{\sqrt{2gx}}}
\end{equation}
の関係式を成すという。さらに、村井の研究\cite{村井祐一20222022.T011}らにより気泡径とその分布が統計されており、その形状は、ポアソン分布に酷似している。
これらから、技術的に大まかにモデル化可能な領域と、その正しさが確認される。すなわち、超音波伝播をシミュレートする上で気泡の数$N$、形状の関数$S_i$、気泡それぞれの座標$\mathbf{r}_i$を決定する必要がある。ここで、形状のモデル化に関しては極めて難しいので、構成要素としては球あるいは円柱を組み合わせただけとする著しい簡略化を行った。ゆえに、これら形状は球の直径$D_i$と円柱の高さ$h_i$の関数としてよく、また、座標$\mathbf{r}_i$の確率分布は$D_i$によって規定されると仮定できる。
これらから、暫定的に条件を満たす分布を以下のように定義して以下議論を進めることとする。$N$は既知とする。

\begin{align}
    &D \sim Pr(\nu) \\
    &h \sim Uni[0,a] \\
    &S =\left\{ \,
    \begin{aligned}
        &Sphere  (0 < D < 1 mm) \\
        &Oblete (1< D <10 mm)\\
        &Spherical-cap (10mm< D )\\
        &fill-bubble 
    \end{aligned}
\right.
\end{align}\par
ここで、spherical -capに関しては仰角が46~64°と定まっているため、60°と定義することによって、曲率半径$R$の関数として体積を導出できる。これは簡単に計算可能で、$\theta=\pi/3$の時は
\begin{equation}
    V(R)=\frac{16-9\sqrt{3}}{24}\pi R^3\sim0.0539R^3
\end{equation}
と計算できる。これらを実装することにより、上昇気液二層流における気泡流、スラグ流、チャーン流、環状流のうち気泡流と環状流のシミュレーションを行えることが期待される。スラグ流・チャーン流は著しく不規則なので、大変な技術的困難が予想される。


\section{数値計算結果}
実際の数値計算による結果と、その概要を示す。目安として、研究室の計算環境であるNvidia RTX 4090を利用した場合には、１データあたりおよそ4時間を要した。前節での物性値をもとにして数値計算を行った。
\subsection{液相のみ}
まず、液相のみのシミュレーションが妥当かどうかを実機をもとに検証する。
\begin{figure}[htbp]
    \centering
    \includegraphics[width=0.5\linewidth]{pictures/results/liquid_only.png}
    \caption{数値計算の計算系の模式図。緑色のものがパイプを模しており、周りを水で満たしているものとする。}
    \label{fig:calculation_system}
\end{figure}出力された結果は以下のようなものであった。
\begin{figure}[htbp]
    \centering
    \includegraphics[width=0.5\linewidth]{pictures/results/liquid_only_signal.png}
    \caption{液相のみの場合のシミュレーション信号波形}
    \label{fig:liquid_only}
\end{figure}
液相のみの条件に関しては実際に実験されており、以下のような結果が存在する。一つのデータを示す。
これらの信号波形について、より詳細な解析を行った。
また、シミュレーション生成の信号のうち、管壁からのものを詳細に解析する。信号に対してはヒルベルト変換により検波処理を行っており、包絡線を取得してある。このとき、以下の結果が得られる。
\begin{figure}[htbp]
    \centering
    \includegraphics[width=0.5\linewidth]{pictures/results/pipe_refrection_sim.png}
    \caption{シミュレーション生成信号の、菅壁付近の信号波形及びヒルベルト変換による包絡線の可視化}
    \label{fig:pipe_reflection}
\end{figure}
\begin{figure}[htbp]
    \centering
    \includegraphics[width=0.5\linewidth]{pictures/results/pipe_refrection_real.png}
    \caption{実機の菅壁付近の信号波形及び包絡線を可視化したもの。}
    \label{fig:pipe_reflection_real}
\end{figure}
これらを比較すると、定性的にはシミュレーション側では山のような形になっており、4回繰り返した信号波形のピークが見えにくい一方で、実機実験の方では先がつぶれたような形状をしていることがわかる。
これらのピークの間の時間差を取得することによって、材質がわかればその厚さが、厚さがわかれば媒体中の音速並びに材質が決定できる。
この超音波厚さ測定に関しては付録\ref{appendix}に詳細な解析結果を示した。この結果に基づきそこでは、音速の値としては$2790\ \mathrm{m/s}$を採用した。
次に、この領域に対してフーリエ解析を実行した。まず、実機データのパイプ部分に対する周波数成分を解析する。
\begin{figure}[htbp]
    \centering
    \includegraphics[width=0.5\linewidth]{pictures/explanation/Fourier_analysis_real.png}
    \caption{実機信号の、菅壁付近の信号波形に対するフーリエ解析結果。$4,8\ \mathrm{MHz}$の地点にピークがみられる。}
    \label{fig:fourier_analysis_real}
\end{figure}
これらから、定性的には$4,8\ \mathrm{MHz}$の地点にピークがみられる。使用しているものとちょうど倍の周波数成分がみられるが、これらは倍音(second harmonic)と呼ばれる。\par
次に、数値計算によって生成した信号に対するフーリエ変換を行った結果を示す。以下は$CFL=0.03$で行ったものである。
\begin{figure}[htbp]
    \centering
    \includegraphics[width=0.5\linewidth]{pictures/explanation/fourier_analysis_sim_0.03.png}
    \caption{CFL=0.03に対する信号波形のフーリエ解析結果。実機と同じ4，8にピークがみられる。}
    \label{fig:fourier_analysis_sim_003}
\end{figure}
次に、$CFL=0.01$で行った結果を示す。
\begin{figure}[htbp]
    \centering
    \includegraphics[width=0.5\linewidth]{pictures/explanation/Fourier_analysis_sim_0.01.png}
    \caption{CFL=0.01に対する信号波形のフーリエ解析結果。実機にはない12の成分を持っている。}
    \label{fig:fourier_analysis_sim_001}
\end{figure}
これらから、周波数空間の観点から、CFLの値としては0.03が好ましいとした。一方で、これらは計算の成立条件を満たしている(\ref{appendix})ので、以下すべてのシミュレーションはこの値のもと行った。
\subsection{固液二層}
3次元シミュレーションによって計測信号波形を生成した。これらは、機械学習用に使用するものである。基本的に機械学習用データは多いほうが望ましいが、多数は不可能であった。故に213のデータを生成し、それによって訓練を行った。その結果を以下に示す。
\begin{figure}[htbp]
    \centering
    \includegraphics[width=0.5\linewidth]{pictures/results/solid_liquid7_processed_0pulse.png}
    \caption{固相粒子を含めた場合の信号波形}
    \label{fig:solid_liquid}
\end{figure}

\chapter{提案手法}
今、適当な何らかの測定を実行している間、その測定領域における真の値が存在する。これらによって超音波の信号波形が何らかの影響をうけて、測定結果として入手することができる。\par
ここで、信号波形から体積率を求めるのと逆の場合、すなわち体積率から信号波形を求める順問題は、比較的容易に解くことができる。固相粒子の個数および一つの粒子の体積、およびその相配置が既知とした場合には、波動方程式に基づく数値的な反復法によって超音波パルスの伝播を再現することができる。よって、数値計算シミュレーションソフトウェアを使用し、ある相体積率及びその相配置に基づく信号波形を生成した。\par
信号波形からそれに対応する相体積率を機械学習で推定する手法の一つには、連続値を推定する回帰モデル、すなわち
\begin{equation}
    p(t | \mathbf{x}, \mathcal{D})
\end{equation}
を推定し、その期待値
\begin{equation}
    \mathbb{E}[t | x ] = \int t p(t |\mathbf{x},\mathcal{D})dt 
\end{equation}
を評価することにより達成できる。よって、その回帰モデルの設計が問題となる。
これらについてだが、設計の要件としては以下のものが挙げられる。\par
・入力信号の現れるピークの位置に関してロバストであること\par
・入力信号は$\mathbb{R}^{1\times W}$の形式を持つ。\par
ここで、信号は極めて長い系列を持ち、全結合型での機械学習モデルの学習にはパラメータ数が発散し計算を行うことが困難である。センサーの数並びに配置によっては管内の流動状態を推定するのに十分でない情報しか入手できない場合があるし、ここで用いている仮定が悪い結果を引き起こす可能性がある。以下に、センサーの数および配置に基づく提案手法を示す。\par
\section{制約条件}
前述(chapter\ref{fig:experiment_setup},page\pageref{fig:experiment_setup})のように、本稿で用いた海洋技術安全研究所の実験データは、対向する二つのトランスデューサで円管を挟み、少し離れた位置においてもう一つのトランスデューサを配置するような配置で実験を行った。ここで、超音波パルスを照射したトランスデューサは片側であり対向側は透過波のみを、送信側は反射波および送信した際の信号をそれぞれ記録している。対向側の菅壁内側からの反射波を計測できる場合、透過波の情報は不要であると考え、まずは一つでの学習結果を示す。
実験系の設定に関する表(\ref{tab:transducer_settings})では3 kHzでのprf,で5秒間の測定を行っている。すなわち、通算15000回の測定を行っている。これらの測定の度に対応する相体積率が存在するため、1回の測定で相体積率を推定する機械学習モデルを訓練し、時間平均をとる必要がある。
これらにおいて、大きく分けて計算機上の制約と実験上の制約が存在する。データセットのサンプルサイズが多すぎれば計算機のメモリにおさまらず、また、実験のスケールの問題で超音波トランスデューサに配置可能な
\section{手法}
\subsection{指標}
例えば、\cite{park2022gas}によると、気相体積率の推定においては、1サンプルに対するError rate として
\begin{equation}
    \text{Error rate} = \frac{\text{True\_value - Predicted\_value}}{\text{True\_value}}
\end{equation}
を用いている。従来、本研究室においても同じ尺度が用いられた。しかし、本来の目的は構成方程式の精度を評価することであることを踏まえると、真値の値に左右されるような指標を用いることによって、本来無視できる誤差を過大評価する場合が存在するのは望ましくない。例えば真値が0に近い場合、精度を大まかに評価する目的であれば2～3の値を出力するようなモデルでもある程度有効であるが、この指標を用いる場合には誤差率が30％等を示し有効でないとされる。そこで、今回の場合に適したRMSEによる評価を行う。
\subsection{固液二層に対する手法}
前節のような制約・要請を解決する手法として、以下のようなアルゴリズムを提案する。すなわち信号波形を縦1pixelの画像とみなし、CNNやVison Transformerといったスパースな画像学習を行うこととする。
ここで、このような問題設定は極めて異例なものであることに注意が必要である。画像処理分野において、一般的な機械学習の応用としてはあくまで分類的な用法が主流となっているからである。例えば、\cite{Bishop:DeepLearning24}を参照するに、現在広く用いられる画像分野における機械学習の応用には人物検出、顔検出、顔認証、物体認識・識別、音声認識などがあるとされるが、これらはすべて分類タスクである。なぜなら、これらはすべてデータが与えられたときに、そのデータ自身が所定のカテゴリに属する確率を計算するモデルにほかならないからである。\par
確かに、画像から回帰を行っている機械学習モデルは存在する。例えば、R-CNN\cite{girshick2014rich}などは、画像に含まれるObjectのカテゴリを決定すると同時に、その画像のどこにその物体が存在しているのかを決定する。これらの学習は、物体が属するカテゴリの確率を計算する分類モデル並びに、物体の存在するピクセルを目標値とした回帰モデル二者の訓練を同時に行うことによって達成される。ここでは詳細に立ち入らないが、注意すべきは、これらの学習は、それらを行う人間の脳の働きを模倣したものということである。人間の情報処理システムは複雑だが、人間ならば実現可能であるという事実があるからこそ、それを正しく予測する関係性が存在し、それを機械学習で抽出するアプローチが正当化される。一方、例えばいくつか人の顔から年齢を予想するような研究では、\cite{sheoran2020age},\cite{guo2008probabilistic}どれもMAEで85\%～90\% 程度の精度を示すものの、モデルの正当性には議論の余地が残る。表面的に表れる年の取り方は必ずしも一定ではなく、健康的な人は若く見えるし、不健康な人は老いて見えるため、それらを数値として予測することが生理学的観点から適切であるかは不明である。ゆえに、年の取り方を定義する場合、健康的な人間だけを集めた人間のみを対象とするか、全体的に考慮するかはさらに議論の必要があると\cite{guo2008probabilistic}は述べている。\par
なお、実装については\cite{torchvstensor}によるとPytorchが支配的なのでこれを用いた。詳細は別資料で示す。
なお、今回の場合においては、センサーでの値の系列から管内流体の複雑系に含まれる潜在変数の値を推定する回帰モデルを設計する問題である。ここで、機械学習は瞬時の体積率を推定する
\begin{equation}
    \mathbf{x}_n \in \mathbb{R}^{1\times W\times C} \stackrel{f(x,w)}{\to} y_n \in \mathbb{R}^1
\end{equation}
の関数として利用され、通時的な量は
\begin{equation}
    \hat y = \frac{1}{N}\sum_n^N y_n
\end{equation}
によって推定される。
ここで、平均および分散を取得し、エラーバーも取得することができる。平均値においては比較的良好な一致が見られたが、分散が非常に大きくなってしまうという結果が得られた。この問題は、トランスデューサの数を増やし、チャネル数$C$を増やすことによって解決できる可能性がある。その際、センサは対向ではなく垂直に配置した場合には、管内の状態についてより多くの情報を得ることができるため相配置の同定に役立つことが予想される。
\subsection{固気液三相流に対する手法}
気液二層流に対する数値計算は気泡形状、気泡体積、気泡配置、気泡数統計などのモデル化を含むため固液二相のモデル化と比して極めて複雑であり、固気液三相流においてはさらなる困難が予想される。また、瞬時の体積率も利用することはできない。一方で、トランスデューサを二つ用い、その相関情報を利用することは予測精度向上に寄与すると考えられる。このような場合においては、1パルスではなくすべてのパルスに対して一つの値を割り当てるモデルを学習するのが望ましい。すなわち
\begin{equation}
    \mathbf{x} \in \mathbb{R}^{H \times W\times C} \stackrel{f(x,w)}{\to} y \in \mathbb{R}^1
\end{equation}
の関数として予測する。ここで、$\mathbf{x}$は超音波画像であり、$w$はモデルのパラメータである。$y$は相体積率である。
モデルに関してはResnet\cite{he2016deep}を用いた。これらによって新しく提案されたアーキテクチャについてはいくつかの解析が存在し、例えば
\cite{li2018visualizing}によれば、より安定した学習を可能にする残渣接続(residual connection)を用いることは、損失関数の表面が滑らかになる効果をもたらすことを視覚的に示している。これらにより、残渣接続なしの場合と比べて学習が局所最適解に陥る可能性が低くなることが期待される。
\begin{figure}[htbp]
    \centering
    \includegraphics[width=0.5\linewidth]{pictures/explanation/loss_landscape.png}
    \caption{\cite{li2018visualizing}より抜粋。残渣接続ありの場合と無しの場合の損失関数の表面を可視化したもの。残渣接続がない場合は表面が粗い一方で、残渣接続がある場合は表面が滑らかになっている。}
    \label{fig:loss_landscape}
\end{figure}

\chapter{学習結果}
回帰モデルをMSE（Mean square error、平均二乗誤差）によって訓練し、その予測精度を評価する。評価に関しては、回帰で一般に用いられるRMSE(Root mean Square error), MAE(Mean Absolute error)を用いた。
\section{固液二層流}
以下は、その予測精度を評価したグラフである。ガラスビーズを固相として用いた場合、石を固相として用いた場合の固相体積率が色分けされてプロットしてある。
\begin{figure}[htbp]
    \centering
    \includegraphics[width=0.4\linewidth]{pictures/results/predicted_vs_ground_truth_noerrorbars.png}
    \caption{縦軸が予測値を、横軸が実測値を示す。ゆえに、点群がy=xに近ければ近いほど精度が高いと判断される。}
    \label{fig:prediction_vs_ground_truth}
\end{figure}

\newpage
\subsection{課題}
これらテストデータに対する偏りとして、相体積率の最大値が0.15(正確には、2024年データにおいて0.149)というものがあげられる。ゆえに、0から0.15までの値をランダムに予測したり、適当な一次関数からのサンプルでもRMSEの率はそれほど高くはならない。このような議論を行う上では統計検定が必要である。平均すればある程度良い予測結果が得られる一方で、いくつかの欠点がある。まず一つに、機械学習の際、訓練データとテストデータ（実機）の評価が大きくずれる事象が数多く見られた。定性的に一定の類似性はみられるとはいえ、シミュレーションと実機ではデータにあまりに多くの差異がある可能性がある。\par
\begin{figure}[htbp]
    \centering
    \includegraphics[width=0.5\linewidth]{pictures/explanation/solid_liquid7_processed_0img.png}
    \includegraphics[width=0.5\linewidth]{pictures/explanation/P20240726-1600_processed_1img.png}
    \caption{シミュレーションと実機試験のデータの比較。両者ともに超音波画像法\ref{ultraimage}によって画像化してある。}
    \label{fig:noerrorbar}
\end{figure}
この二つの画像は、そのサンプルである。超音波パルスの幅や、多重反射が明瞭に確認できる回数などに違いが見て取れる。それでも一定の精度を得られたのは、情報処理のメカニズムにおいて、学習の過程でたまたま十分にロバストで実機データを処理するのにも使用可能な局所最適解・パターンを発見したからである可能性が高い。事実、学習率をさげて訓練を行った場合には、訓練データに対してよい精度を示しかつ安定的な学習を行った一方で実機データの値を適切に予測することができなくなった。
だが、それよりも重要なのは、予測に際し分散が非常に大きいということである。上記のグラフは平均値のみをプロットしたが、時間平均を計算する過程で評価できる分散の値も同時にプロットすると
\begin{figure}[htbp]
    \centering
    \includegraphics[width=0.5\linewidth]{pictures/explanation/predicted_vs_ground_truth_2.png}
    \caption{Caption}
    \label{fig:errorbars}
\end{figure}
のように、著しくError barが大きく表示されてしまうという問題点がある。これらへの考察として、トランスデューサの数が少ないからというものが挙げられる。機械学習とは統計的なパターン認識技術にすぎないので、予測とは尤もらしい予測とそれに付随する分散によって評価されるからであると考えられる。\par
一方で、実はこれら推定値はリアルタイムにおける相体積率を正しく推定しているという主張もある。実験では5秒間の測定を行っており、3 kHz回の測定の間に真の物理量は明らかに変動しうる。しかし、今回の場合算出したのは平均および分散、標準偏差である。
\subsection{問題解決の提案}
より信頼性の高いモデルを構築しようとした場合に重要なのは、ハイスピードカメラで計測した画像とシミュレーションの予測値を比較することだろう。これらには人力でのアノテーションを必要とするため、現時点でのリソースでは困難である。
\section{固気液三相流}
以下は、その予測精度を評価したグラフである。6つの目標変数を同時にプロットしてある。それらは、気相速度、液相速度、固相速度、気相体積率、液相体積率、固相体積率、である。
\begin{figure}[htbp]
    \centering
    \includegraphics[width=0.8\linewidth]{pictures/results/overview_prediction_plots.png}
    \caption{縦軸が予測値を、横軸が実測値を示す。気相速度、気相体積率においては良好な予測が得られているのが視覚的にも確認できる。}
    \label{fig:prediction_vs_ground_truth}
\end{figure}
これらに対し、決定係数$R^2$、RMSE、MAEを計算すると、以下のような結果が得られた。
\begin{table}[ht]
    \centering
    \begin{tabular}{c|c|c|c|c|c|c}
    \hline
         variable & solid velocity & gas velocity & liquid velocity & solid volume fraction & gas volume fraction & liquid volume fraction \\
         \hline
         $R^2$ & -0.43 & 0.95 & 0.34 & -0.38 & 0.94 & 0.86 \\
         RMSE & 0.28 & 5.1 & 0.94 & 0.034 & 0.073 & 0.11 \\
         MAE & 0.20 & 4.0 & 0.77 & 0.027 & 0.059 & 0.094 \\
         \hline 
    \end{tabular}
    \caption{決定係数$R^2$、RMSE、MAEの結果。}
    \label{tab:prediction_results}
\end{table}\par
これらにより、予測が可能な変数と、機械学習を以てしても予測が困難な変数がわかる。
\subsection{課題}
固相体積率・固相見かけ流速・液相見かけ流速において課題が示された。液相に関しては、管内の流れに対し信号を得ることは難しく、また、固相の反射のような微弱な信号は、外部のノイズに埋もれてしまい検出が難しいことが予想される。
これらに関しては、さらなる複雑な信号処理が必要となる。
また、機械学習を使用している以上、問題設定に対して存在しない範囲のデータに対しては予測が困難となる。機械学習の一般的な性質として、外挿による予測が弱いというものが挙げられる。

\subsection{問題解決の提案}
それらのため、実際の運用をみこし、より実際の状況に近い実験を行い、計測信号を得るのが望ましい。例えば、現時点においてはガラスビーズ、水、石の固気液三相流を対象にしているが、実際の運用では泥水、石、空気の三相流になることが予想される。泥水の、超音波に対する音響インピーダンスは水のそれと異なるため信号波形は弱くなることが予想され、また、実際の系では圧力も大きく異なる。他にも、パイプの材質といった物性に関しても予測精度に影響を与えるだろう。
そこで、次回以降行う実験としては、高圧力による実験条件を行い、また泥水による実験を行い計測データを得ることが望ましいだろう。そうすれば、実運用の際にも性能が大きくは低下しないであろうことが予想される。
\section{考察}
以上より、深層学習によって、特に気相のみかけ流速と相体積率を推定するモデルが得られた。これらの予測メカニズムの考察を行う。
\subsection{判断メカニズムの考察}
saliency map による、モデルの予測に対する寄与度を可視化する。以下は、最も良い精度を達成したモデルに対するsaliency mapを可視化したものである。
気相みかけ流速の予測についての考察を行い、次に気相体積率の予測についての考察を行う。
気相みかけ流速についての予測メカニズムであるが、もっとも有力なものはTDX1,TDX2の間の統計的に類似したパターンを検出し、それらに線形な変換を施すことによって相関の高い値を出力するといったメカニズムである。これが正しければ、例えばTDX1のみを利用して学習した場合にはその信号パターンの時間差をもとに速度を算出することができないため、精度が落ちることが考えられる。しかし、実際には以下のような結果が得られた。これらの算出には、使用するチャンネル数のみを二つから一つに減らし、その他のハイパーパラメータ最適化アルゴリズムに関しては変更を加えていない。
これらの結果から、気相みかけ流速の予測については、TDX1,TDX2の間の統計的に類似したパターンを検出し、それらに線形な変換を施すことによって相関の高い値を出力するといったメカニズムは考えにくいということが考えられる。
\subsection{管径に依存しないモデルの構築}
管径が異なるモデルにおける予測精度を評価できているわけではなく、評価のためのデータセットも以前として準備段階にあるというのが現状である。産総研でのデータセットに関しては、管とトランスデューサの距離が近すぎるために信号パターンが大きく異なってしまう。令和7年に取得したデータセットに関しては汎化が可能である可能性がある。



\chapter{結論}
固気液三相流において、超音波信号を入力、締切法によって計測した値を目標値として深層学習モデルを構築した。今回開発したモデルは、気相みかけ流速、気相体積率の予測において決定係数0.9以上を達成した。また、固液二相においては数値計算による信号波形を学習したが、実機に対する予測としても比較的良い精度を達成し、その判断根拠としては向かい側の菅壁からの反射波の部分に着目している結果が得られた。
\backmatter
\chapter{謝辞}
\bibliographystyle{junsrt}
\bibliography{reference}
\appendix\label{appendix}

\chapter{付録}
機械学習は統計的な手法であり、アルゴリズムの設計にもその性能評価にもいくつかの数学的準備を必要とする。ここでは、用いた議論や論拠の補足を行う。
\section{指標}
分類・回帰の性能評価に関する議論を行う。分類モデルに関しては精度・再現率・F値といった数々の指標が良く議論されている一方で、回帰タスクにおいては十分に行われていないようである。ここでは、その性能指標について、今回RMSEをMAEよりも好むかの理由について述べる。\par
そもそも、今回は固相体積率という連続値をとる量を推定する目的で研究が行われてきた。その理由は、構成方程式の精度を検証するためであった。誤差が生じる状況を大きく二分するとすれば、次の二つのケースが考えられる。
\begin{description}
    \item[1.] 全体的に中程度の誤差が出て、大きな誤差を取るものが極めて少ない
    \item[2.] 全体的に小程度の誤差が出て、一部のみ大きな誤差を取るものが存在する。
\end{description}
このうち、精度を検証する目的では全体的な中程度の誤差は、一部の大きな誤差よりも優先される。MAEではその誤差に対して線形な損失を割り当てるのに対し、MSEではその誤差の二乗の損失を割り当てる。それゆえ、L1Loss（MAE）よりもL2Loss(MSE)のほうが望ましい。さらに言えば、ある程度の誤差が許容されるのであればより高次のLossを用いるのさえ望ましい。MAEを利用しない理由はこれである。
\section{物性値}
物性値に関しては、現在に至るまでの数々の実験から再現可能な量が測定されてある。まず初めに、計算系において物性値を以下のように設定した。
\begin{table}[htbp]
    \centering
    \begin{tabular}{c|c|c|c}
    \hline
         substance & Acoustic impedance & density & sound velocity \\
         \hline
         air&  0.00043 & 1.3 & 330\\
         water& 1.5 & 1000 & 1500\\
         glass & 18.9 & 2200 & 5300\\
         \hline
    \end{tabular}
    \caption{acoustic impedance used in the experiment}
    \label{tab:acoustic impedance}
\end{table}
いくつかの書類には25A塩ビ管を利用しているという記載があり、研究員の共通認識であった。しかし、予備試験の結果により、音速が$2790\ \mathrm{m/s}$程度であることが判明した。このことから、塩ビ管ではなくアクリルではないかという疑念が存在し、実験設備の構築を担当する方に確認を取ったところ、アクリル管を利用していることが判明した。このことから、音速を$2790\ \mathrm{m/s}$として計算を行った。
今後、同様のアプローチを採用する場合には、厚さ測定及び材質の音速の再推定結果に基づいて検証することが望ましい。
なお、材質の音速推定については、以下のような方法で行った。
\begin{description}
    \item[1.] 信号をヒルベルト変換する
    \item[2.] 管内壁、外壁でピークを取る時刻をそれぞれ取得し、比較する
    \item[3.] 厚さを時間差で除算することによって音速を推定する。
\end{description}
「信号をヒルベルト変換する」について解説する。実機試験を行った場合の1パルスの測定結果を以下に示す。\par
\begin{figure}[htbp]
    \centering
    \includegraphics[width=0.5\linewidth]{pictures/explanation/signal_sample.png}
    \caption{実機試験を行った場合の1パルスの測定結果。}
    \label{fig:hilbert_transform}
\end{figure}
これらのうち、見えやすい最初のピークと、その次のピークをさらに拡大して表示する。この際、ヒルベルト変換を行い、包絡線を取得してある。\par
\begin{figure}[htbp]
    \centering
    \includegraphics[width=0.5\linewidth]{pictures/explanation/pipe_refrection_real.png}
    \caption{パイプの外壁、内壁を拡大した画像}
    \label{fig:real_signal}
\end{figure}
ここで、形状が綺麗に一つのピークを持たず、何回かのピークがあるのが見て取れる。理想的には、シミュレーションの結果のように、\ref{fig:simsignal}のようになる。
\begin{figure}[htbp]
    \centering
    \includegraphics[width=0.5\linewidth]{pictures/explanation/pipe_refrection_sim.png}
    \caption{シミュレーションの信号波形の、菅壁付近の拡大。ヒルベルト変換後のピークが唯一である。}
    \label{fig:simsignal}
\end{figure}
ここで、ピークが複数回出ている理由は、実機のトランスデューサの機器依存の現象である。しかし、内壁、外壁それぞれのピークの間の時間差には対応関係が存在する。それらを測定すると、時間差は$2.15\pm 0.019\ \mathrm{\mu s}$である。このことから、音速を$2790\ \mathrm{m/s}$と推定することができる。\par
なお、塩ビ管の音速は、$2300\ \mathrm{m/s}$程度であり、あまりに誤差が大きい。パイプの厚みが$3\ \mathrm{mm}$ではなく、$2.5\ \mathrm{mm}$であったならば矛盾はないが、数値計算の上ではこれらを明確に確認する必要がある。
\end{document}
